name: Build and Deploy Docs

on: push

jobs:
  build: # Keep your existing build job - rename it for clarity
    name: Build Docs and Lint
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install Redocly CLI
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli

      # Lint OpenAPI spec
      - name: Lint OpenAPI Spec
        run: redocly lint api-specs/api-v1.yaml

      # Build docs
      - name: Build Docs
        run: |
          redocly bundle api-specs/api-v1.yaml --output docs/bundled-api-v1.yaml
          redocly build-docs docs/bundled-api-v1.yaml --output docs/index.html

      # Upload docs artifact
      - name: Upload Docs Artifact
        uses: actions/upload-artifact@v3
        with:
          name: docs-output # Name of the artifact
          path: docs # Path to the 'docs' directory containing index.html

  deploy: # Add a new deploy job
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build # Ensure 'deploy' job runs after 'build' job is successful
    permissions: # Required for GitHub Pages deployment
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: docs-output # Name of the artifact we uploaded in the 'build' job
          path: docs-to-deploy # Download to a 'docs-to-deploy' directory in the deploy job

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: docs-to-deploy # Path to the directory containing your static site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3