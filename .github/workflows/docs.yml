name: Build and Deploy Docs

on:
  push:
    branches:
      - main # Or your default branch name (e.g., master)
  # Allow manual trigger
  workflow_dispatch:

jobs:
  build:
    name: Build Docs and Lint
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install Redocly CLI
      - name: Install Redocly CLI
        run: npm install -g @redocly/cli

      # Lint OpenAPI spec
      - name: Lint OpenAPI Spec
        run: redocly lint api-specs/api-v1.yaml

      # Build docs
      - name: Build Docs
        run: |
          redocly bundle api-specs/api-v1.yaml --output docs/bundled-api-v1.yaml
          redocly build-docs docs/bundled-api-v1.yaml --output docs/index.html

      # --- Optional Debugging Step (Uncomment if still having issues) ---
      # - name: List contents of docs directory
      #   run: ls -R docs
      # --- End Debugging ---

      # Upload docs artifact (Using v4)
      - name: Upload Docs Artifact
        uses: actions/upload-artifact@v4 # <-- Updated to v4
        with:
          name: docs-output # Keep the name consistent
          path: docs # Path to the 'docs' directory containing index.html
          retention-days: 1 # Optional: Keep artifacts for fewer days

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build # Ensure 'deploy' job runs after 'build' job is successful
    permissions: # Required for GitHub Pages deployment
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # No checkout needed here if only using artifact

      # Setup Pages (Using v4)
      - name: Setup Pages
        uses: actions/configure-pages@v4 # <-- Updated to v4

      # Download artifact (Using v4)
      - name: Download Artifact
        uses: actions/download-artifact@v4 # <-- Updated to v4
        with:
          name: docs-output # Must match the upload name

      # --- Debugging Step: Check downloaded files ---
      # - name: List downloaded artifact contents
      #   run: ls -R .
      # --- End Debugging ---

      # Upload Pages artifact (Using v3 - this is the latest for pages artifact)
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3 # <-- Use v3 for pages-artifact
        with:
          # By default, download-artifact@v4 puts files in the root.
          # If you specified a 'path' in download-artifact, use that here.
          path: '.' # Assuming download artifact puts files in the root

      # Deploy to GitHub Pages (Using v4)
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 # <-- Updated to v4